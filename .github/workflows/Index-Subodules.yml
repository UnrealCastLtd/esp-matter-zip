- name: Generate and Compare Submodules Index
  id: generate_index
  run: |
    # Recursive function to find submodules in a given commit tree
    list_submodules_recursive() {
      local commit=$1
      local prefix=$2

      # Find submodules at this level
      git ls-tree "$commit" | awk '/160000/ {print $4, $3}' | while read path subcommit; do
        echo "${prefix}${path}"
        # Recurse into this submodule commit
        list_submodules_recursive "$subcommit" "${prefix}${path}/"
      done
    }

    # Start from HEAD
    list_submodules_recursive HEAD "" > submodules-new.txt

    # Compare with previous version
    if [ -f Zipped-Code/submodules.txt ]; then
      if cmp -s submodules-new.txt Zipped-Code/submodules.txt; then
        echo "No changes in submodules list. Skipping commit."
        echo "changes_detected=false" >> $GITHUB_OUTPUT
      else
        echo "Changes detected. Proceeding with commit."
        mv submodules-new.txt Zipped-Code/submodules.txt
        echo "changes_detected=true" >> $GITHUB_OUTPUT
      fi
    else
      echo "submodules.txt does not exist. Creating and committing new file."
      mv submodules-new.txt Zipped-Code/submodules.txt
      echo "changes_detected=true" >> $GITHUB_OUTPUT
    fi

    rm -f submodules-new.txt
