name: Zip Submodules

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  zip-and-move:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Verify submodules.txt exists
        run: |
          if [ ! -f "Zipped-Code/submodules.txt" ]; then
            echo "Error: The file Zipped-Code/submodules.txt was not found."
            exit 1
          fi

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y zip git

      - name: Set up and run script
        run: |
          set -euo pipefail
          mkdir -p Zipped-Code

          while IFS= read -r line; do
            if [[ "$line" =~ \[submodule\ \"(.*)\"\] ]]; then
              module_name="${BASH_REMATCH[1]}"

              # Read subsequent lines for path, url, branch (optional), and Folder
              read -r path_line
              path=$(echo "$path_line" | sed -e 's/^[[:space:]]*path[[:space:]]*=[[:space:]]*//')
              
              read -r url_line
              url=$(echo "$url_line" | sed -e 's/^[[:space:]]*url[[:space:]]*=[[:space:]]*//')
              
              # Check if the next line is branch or Folder
              read -r next_line
              if [[ "$next_line" =~ ^[[:space:]]*branch ]]; then
                branch=$(echo "$next_line" | sed -e 's/^[[:space:]]*branch[[:space:]]*=[[:space:]]*//')
                read -r folder_line
              else
                branch=""
                folder_line="$next_line"
              fi
              folder=$(echo "$folder_line" | sed -e 's/^[[:space:]]*Folder[[:space:]]*=[[:space:]]*//')

              echo "ðŸ“¦ Processing submodule: $module_name"
              echo "    Path: $path"
              echo "    URL: $url"
              echo "    Branch: ${branch:-master}"
              echo "    Destination Folder: $folder"

              temp_dir="temp_clone"
              rm -rf "$temp_dir"

              # Clone the repository (use branch if available)
              if [ -n "$branch" ]; then
                git clone --depth 1 --branch "$branch" "$url" "$temp_dir"
              else
                git clone --depth 1 "$url" "$temp_dir"
              fi

              if [ ! -d "$temp_dir" ]; then
                echo "Error: git clone failed for $url"
                exit 1
              fi

              # Prepare the destination folder
              mkdir -p "$folder"

              # Zip the **contents only**, not the top-level temp directory
              cd "$temp_dir"
              zip -r "../temp.zip" . -x "*.git*"
              cd ..
              
              mv temp.zip "$folder/$(basename "$module_name").zip"

              # Clean up temporary directory
              rm -rf "$temp_dir"

              echo "âœ… Successfully zipped and moved $module_name"
              echo "---------------------------------------"
            fi
          done < Zipped-Code/submodules.txt

      - name: Upload Zipped Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zipped-submodules
          path: Zipped-Code/
