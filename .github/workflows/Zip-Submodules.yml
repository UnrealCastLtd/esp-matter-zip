name: Zip Submodules Individually

on:
  workflow_dispatch:

jobs:
  zip-submodules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y zip git

      - name: Prepare output folder
        run: mkdir -p main/Zipped-Code

      - name: Process submodules.txt and create zips
        run: |
          set -euo pipefail

          INPUT_FILE="Zipped-Code/submodules.txt"
          DEST_FOLDER="main/Zipped-Code"
          TEMP_FOLDER="temp_submodule"

          # Parse the TXT file and iterate submodules
          awk '
            BEGIN { url=""; branch=""; folder="" }
            /^\[submodule/ { if (url != "" && folder != "") { print url "|" branch "|" folder } url=""; branch=""; folder="" }
            /url =/    { url=$3 }
            /branch =/ { branch=$3 }
            /Folder =/ { folder=$3 }
            END { if (url != "" && folder != "") { print url "|" branch "|" folder } }
          ' "$INPUT_FILE" | while IFS="|" read -r url branch folder; do
            echo "ðŸ“¦ Processing:"
            echo "    URL: $url"
            echo "    Branch: ${branch:-master}"
            echo "    Folder: $folder"

            # Clean temp folder
            rm -rf "$TEMP_FOLDER"
            mkdir -p "$TEMP_FOLDER"

            # Clone shallow
            if [ -n "$branch" ]; then
              git clone --depth 1 --branch "$branch" "$url" "$TEMP_FOLDER"
            else
              git clone --depth 1 "$url" "$TEMP_FOLDER"
            fi

            # Ensure DEST_FOLDER exists
            mkdir -p "$DEST_FOLDER"

            # Create zip file for this module
            ZIP_NAME=$(basename "$folder").zip

            # Zip top-level content only, exclude .git
            cd "$TEMP_FOLDER"
            zip -r "../../$DEST_FOLDER/$ZIP_NAME" . -x "*.git*" > /dev/null
            cd ..

            # Cleanup temp folder
            rm -rf "$TEMP_FOLDER"

            echo "âœ… Created $DEST_FOLDER/$ZIP_NAME"
          done
