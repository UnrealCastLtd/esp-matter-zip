name: Zip Submodules Only

on:
  workflow_dispatch:

jobs:
  zip-submodules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Install zip
        run: sudo apt-get update && sudo apt-get install -y zip

      - name: Create Zipped-Code folder
        run: mkdir -p main/Zipped-Code

      - name: Zip submodules listed in submodules.txt
        run: |
          set -euo pipefail

          INPUT_FILE="Zipped-Code/submodules.txt"
          DEST_FOLDER="main/Zipped-Code"

          # Read each Folder entry
          grep "^	Folder =" "$INPUT_FILE" | awk -F'=' '{gsub(/^[ \t]+|[ \t]+$/,"",$2); print $2}' | while read -r folder; do
            if [ -d "$folder" ]; then
              submodule_name=$(basename "$folder")
              zip_file="$DEST_FOLDER/$submodule_name.zip"
              echo "üì¶ Zipping $folder -> $zip_file"

              # Zip contents of the folder directly, not including the folder itself
              (cd "$folder" && zip -r "$zip_file" . -x "*.git*" > /dev/null)

              # Remove the folder after zipping to save VM space
              rm -rf "$folder"
            else
              echo "‚ö†Ô∏è Folder not found: $folder"
            fi
          done
