name: Zip Submodules Individually

on:
  workflow_dispatch:

jobs:
  zip-submodules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Install zip
        run: sudo apt-get update && sudo apt-get install -y zip git

      - name: Prepare output folder
        run: mkdir -p main/Zipped-Code

      - name: Process submodules.txt and create zips
        run: |
          set -euo pipefail

          INPUT_FILE="Zipped-Code/submodules.txt"
          DEST_FOLDER="main/Zipped-Code"
          TEMP_FOLDER="temp_submodule"

          awk '
            BEGIN {url=""; branch="master"; folder=""}
            /^\[submodule/ { if (url != "" && folder != "") {
                               print url "|" branch "|" folder
                             }
                             url=""; branch="master"; folder="" }
            /url =/    {url=$3}
            /branch =/ {branch=$3}
            /Folder =/ {folder=$3}
            END { if (url != "" && folder != "") {
                    print url "|" branch "|" folder
                  } }
          ' "$INPUT_FILE" | while IFS="|" read -r url branch folder; do
            echo "ðŸ“¦ Processing:"
            echo "    URL: $url"
            echo "    Branch: $branch"
            echo "    Folder: $folder"

            rm -rf "$TEMP_FOLDER"

            # Clone shallow
            git clone --depth 1 --branch "$branch" "$url" "$TEMP_FOLDER"

            # Decide destination path
            zip_name=$(basename "$folder").zip
            dest_path="$DEST_FOLDER/$folder/$zip_name"

            echo "    Creating: $dest_path"
            mkdir -p "$(dirname "$dest_path")"

            # Zip repo contents (flat, no extra folder, no .git)
            (cd "$TEMP_FOLDER" && zip -r "$GITHUB_WORKSPACE/$dest_path" . -x "*.git*" > /dev/null)

            rm -rf "$TEMP_FOLDER"
            echo "    âœ… Done"
          done
