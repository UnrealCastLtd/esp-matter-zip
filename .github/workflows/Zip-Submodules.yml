name: Zip Submodules Individually

on:
  workflow_dispatch:

jobs:
  zip-submodules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Install zip
        run: sudo apt-get update && sudo apt-get install -y zip git

      - name: Create Zipped-Code folder
        run: mkdir -p main/Zipped-Code

      - name: Zip submodules from submodules.txt
        run: |
          set -euo pipefail

          INPUT_FILE="Zipped-Code/submodules.txt"
          DEST_FOLDER="main/Zipped-Code"
          TEMP_FOLDER="temp_submodule"

          grep "^	Folder =" "$INPUT_FILE" | awk -F'=' '{gsub(/^[ \t]+|[ \t]+$/,"",$2); print $2}' | while read -r folder; do
            # Get the URL and branch from the same submodule block
            url=$(awk -v f="$folder" '
              BEGIN {url=""}
              $0 ~ "\\[submodule" {inblock=0}
              $0 ~ f {inblock=1}
              inblock && $1=="url" {url=$3; print url; exit}
            ' "$INPUT_FILE")

            branch=$(awk -v f="$folder" '
              BEGIN {branch="master"}
              $0 ~ "\\[submodule" {inblock=0}
              $0 ~ f {inblock=1}
              inblock && $1=="branch" {branch=$3; print branch; exit}
            ' "$INPUT_FILE")

            if [ -z "$url" ]; then
              echo "âš ï¸ URL not found for folder: $folder, skipping."
              continue
            fi

            echo "ðŸ“¦ Processing submodule: $folder"
            echo "    URL: $url"
            echo "    Branch: ${branch:-master}"

            # Remove any old temp folder
            rm -rf "$TEMP_FOLDER"
            mkdir -p "$TEMP_FOLDER"

            # Clone only the submodule into temp folder (shallow)
            git clone --depth 1 --branch "${branch:-master}" "$url" "$TEMP_FOLDER"

            # Zip contents directly into DEST_FOLDER
            zip_name=$(basename "$folder").zip
            echo "    Creating zip: $DEST_FOLDER/$zip_name"
            (cd "$TEMP_FOLDER" && zip -r "../$DEST_FOLDER/$zip_name" . -x "*.git*" > /dev/null)

            # Remove temp folder to free VM space
            rm -rf "$TEMP_FOLDER"
          done
