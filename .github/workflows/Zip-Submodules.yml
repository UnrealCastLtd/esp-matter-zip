name: Zip ConnectedHomeIP Module

on:
  workflow_dispatch:

jobs:
  zip-connectedhomeip:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y zip git

      - name: Prepare output folder
        run: mkdir -p main/Zipped-Code

      - name: Zip connectedhomeip
        run: |
          set -euo pipefail

          URL="https://github.com/espressif/connectedhomeip.git"
          BRANCH="master"
          FOLDER="connectedhomeip"
          TEMP_FOLDER="temp_submodule"

          echo "ðŸ“¦ Processing $URL"

          # Clean temp folder
          rm -rf "$TEMP_FOLDER"
          mkdir -p "$TEMP_FOLDER"

          # Clone repo shallow, no submodules
          git clone --branch "$BRANCH" --depth 1 "$URL" "$TEMP_FOLDER"

          # Create zip of only the main repo content
          ZIP_NAME="${FOLDER}.zip"
          echo "    Creating: main/Zipped-Code/$ZIP_NAME"
          cd "$TEMP_FOLDER"
          zip -r "../main/Zipped-Code/$ZIP_NAME" . -x "*.git*" -x "*/.gitmodules" -x "*/third_party/*" > /dev/null
          cd ..

          # Clean up temp folder
          rm -rf "$TEMP_FOLDER"
